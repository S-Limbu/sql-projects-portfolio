- 🧠 Problem / Business Scenario: You work as a Customer Insights Analyst for an e-commerce company. 
The marketing team wants to segment customers based on their Recency, Frequency, and Monetary value to:
reward top customers, re-engage low-value ones and identify regular buyers
Your job is to generate an RFM (Recency-Frequency-Monetary) table using order history and segment customers accordingly.

- 📚 Concepts: CTE + MAX + COUNT + GROUP BY + CASE WHEN + ELSE

- 💡 Why this matters: 
  - Helps marketing teams identify and reward loyal or high-value customers.
  - Focuses marketing spend where it matters most, reducing wasted effort.
  - RFM is a proven method to predict future revenue and prioritize retention efforts.

-- 🔄 1. Drop existing table to avoid conflicts

DROP TABLE IF EXISTS orders;

-- 🧱 2. Create the table schema

CREATE TABLE orders (
  order_id INT,
  customer_id INT,
  order_date DATE,
  amount DECIMAL
);

-- 📊 3. Insert sample/mock data

INSERT INTO orders VALUES
(1, 101, '2024-01-01', 100),
(2, 102, '2024-01-15', 200),
(3, 101, '2024-02-01', 150),
(4, 103, '2024-03-01', 300),
(5, 103, '2024-03-05', 430),
(6, 104, '2024-03-08', 210),
(7, 102, '2024-03-10', 540),
(8, 105, '2024-03-10', 210),
(9, 106, '2024-03-12', 280),
(10, 107, '2024-03-15', 340),
(11, 107, '2024-03-17', 320),
(12, 105, '2024-03-20', 430),
(13, 108, '2024-03-25', 210),
(14, 109, '2024-04-01', 160),
(15, 110, '2024-04-07', 290),
(16, 102, '2024-04-11', 440),
(17, 107, '2024-04-13', 230),
(18, 103, '2024-04-13', 500);

-- 🔍 4. Final query

WITH rfm AS (
SELECT 
customer_id,
MAX(order_date) AS last_order,
COUNT(*) AS frequency,
SUM(amount) AS monetary
FROM orders
GROUP BY customer_id
)
SELECT 
customer_id,
CURRENT_DATE - last_order AS recency_days,
frequency,
monetary,
CASE 
WHEN frequency >= 2 AND monetary > 200 THEN 'Top Customer'
WHEN frequency = 1 AND monetary < 150 THEN 'Low Value'
ELSE 'Regular'
END AS segment
FROM rfm;

-- 🖼️ Screenshot: screenshots/25-rfm-segmentation-result.png
-- 📝 Output: Seperates the customers into tiers to see those eligble for any special loyalty benefits.
